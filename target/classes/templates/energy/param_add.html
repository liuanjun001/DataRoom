<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
    <head>
 <!--[if lt IE 9]> 
<script src="js/html5shiv.min.js"></script>
<![endif]-->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"	name="viewport" />
<title th:text="#{system.systemname}"></title>
<link rel="icon" th:href="@{/favicon.ico}" type="image/x-icon" />
<link rel="stylesheet" th:href="@{/js/easyui/themes/bootstrap/easyui.css}" />
<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
 
 
<!-- Theme style -->
<link rel="stylesheet" th:href="@{/css/base.css}" />
<link rel="stylesheet" th:href="@{/css/dark-skins.css}" />
<link rel="stylesheet" th:href="@{/css/index.css}" />
<link rel="stylesheet" th:href="@{/fonts/css/font-awesome.min.css}" />
 <link rel="stylesheet" th:href="@{/css/DataRoom.css}" />
<link rel="stylesheet" th:href="@{/css/base.css}" />
<link rel="stylesheet" th:href="@{/css/dark-skins.css}" />
 
<style th:inline="text">
 
 </style>
<script th:src="@{/js/jquery-1.12.4.min.js}" type="text/javascript"></script>
<script th:src="@{/js/JQueryUi/jquery-ui.min.js}"></script>
<script th:src="@{/js/easyui/jquery.easyui.min.js}"></script>	
<script  th:src="@{/js/bootstrap.min.js}"></script>
 <script  th:src="@{/js/DataRoomService.js}" type="text/javascript"></script>
 <script type="text/javascript"  th:src="@{/js/DataRoomComm.js}"></script>
 
<script th:inline="javascript" type="text/javascript">
	/*<![CDATA[*/
		var closecallback=null;
	var deviceid=null;
	var addressid=null;
	var addressname=null;
	var parameterid=null;
	var paramdata=null;
function setCallParam(param,callback){
	closecallback=callback;
	parameterid=param.parameterid;
	addressid=param.addressid;
	addressname=param.addressname;
	paramdata=param;
	if(parameterid!=null&&parameterid.length>0){
	$("#parametername").val(param.parametername);
	$("#dynamicbindrate").val(param.dynamicbindrate);
	$("#dynamicbindoffset").val(param.dynamicbindoffset);
	$("#staticbindrate").val(param.staticbindrate);
	$("#staticbindoffset").val(param.staticbindoffset);	
	}	
	getDeviceList();
	}
function getDeviceList(){
	DataRoomService.callDataRoomService("EnergySetService","QueryAddressDevice",{addressid:addressid},showDeviceListResult,this,true);			 
}
function showDeviceListResult(data,callobj){
	var staticbindevice=$("#staticbindevice");
	var dynamicbindevice=$("#dynamicbindevice");
	staticbindevice.empty();
	dynamicbindevice.empty();
	staticbindevice.append('<option value="" disabled="disabled" selected="selected">请选择设备</option>');
	dynamicbindevice.append('<option value="" disabled="disabled" selected="selected">请选择设备</option>');
	for(var i=0;data!=null&&i<data.length;i++){
		var deviceid=data[i].controllerid+'.'+data[i].deviceid;
		 
		staticbindevice.append('<option value="'+deviceid+'" '+  (paramdata!=null&&paramdata.dynamicbinddeviceid==deviceid?'selected="selected"':'') +'>'+data[i].controllername+'.'+data[i].devicename+'</option>');
		dynamicbindevice.append('<option value="'+deviceid+'" '+  (paramdata!=null&&paramdata.staticbinddeviceid==deviceid?'selected="selected"':'') +'>'+data[i].controllername+'.'+data[i].devicename+'</option>');
	
	}
	if(paramdata!=null ){
		getDeviceDigitaldictList("dynamic");
		getDeviceDigitaldictList("static");
	}
}
function getDeviceDigitaldictList(type){
	var callobj=$("#dynamicbindevice");
	var deviceid=callobj.val();
	if(type=="static"){
		callobj=$("#staticbindevice");
		deviceid=callobj.val();
	}

	if(deviceid!=null&&deviceid.length>0){
	DataRoomService.callDataRoomService("EnergySetService","QueryDeviceDigitaldict",{deviceid:deviceid},showDeviceDigitaldicResult,callobj,true);
	}
}
function showDeviceDigitaldicResult(data,callobj){
 	var callobjid=callobj.attr("id");
 	var obj=$("#dynamicbindevicetargetcode");
 	var vparamdata=paramdata!=null?paramdata.dynamicbinddevicetargetcode:null;
	if(callobjid=="staticbindevice"){
		obj=$("#staticbinddevicetargetcode");
		 vparamdata=paramdata!=null?paramdata.staticbinddevicetargetcode:null;
		 paramdata.staticbinddevicetargetcode=null;
	}else{
		paramdata.dynamicbinddevicetargetcode=null;
	}
	obj.empty();
	obj.append('<option value="" disabled="disabled" selected="selected">请选择数据点位</option>');

	for(var i=0;i<data.length;i++){
		var Digitaldicid=data[i].id;
		obj.append('<option value="'+Digitaldicid+'" '+  (vparamdata!=null&&vparamdata==Digitaldicid?'selected="selected"':'') +'>'+data[i].name+'</option>');
	}
}
function checkinput(){
	var parametername=$("#parametername").val();
	var dynamicbindrate=	$("#dynamicbindrate").val();
	var dynamicbindoffset=$("#dynamicbindoffset").val();
	var staticbindrate=$("#staticbindrate").val();
	var staticbindoffset=$("#staticbindoffset").val();	 
	var dynamicbinddeviceid=$("#dynamicbindevice").val();
	var staticbinddeviceid=$("#staticbindevice").val();
	var dynamicbinddevicetargetcode=$("#dynamicbindevicetargetcode").val();
	var staticbinddevicetargetcode=$("#staticbinddevicetargetcode").val();
	 if(parametername==null||parametername.length<1){
		 alert("参数名称为空！");
		 $("#parametername").focus();
			return false;
	 }
	 if(dynamicbinddeviceid==null||dynamicbinddeviceid.length<1){
		 alert("动态绑定设备为空！");
		 $("#dynamicbindevice").focus();
			return false; 
	 }
	 if(staticbinddeviceid==null||staticbinddeviceid.length<1){
		 alert("静态绑定设备为空！");
		 $("#staticbindevice").focus();
			return false; 
	 }
	 if(dynamicbinddevicetargetcode==null||dynamicbinddevicetargetcode.length<1){
		 alert("动态绑定设备点位为空！");
		 $("#dynamicbinddevicetargetcode").focus();
			return false; 
	 }
	 if(staticbinddevicetargetcode==null||staticbinddevicetargetcode.length<1){
		 alert("静态绑定设备点位为空！");
		 $("#staticbinddevicetargetcode").focus();
			return false; 
	 }
	 if(dynamicbindrate==null||dynamicbindrate.length<1){
		 alert("动态绑定放大率为空！");
		 $("#dynamicbindrate").focus();
			return false;
	 }
	 if(staticbindrate==null||staticbindrate.length<1){
		 alert("静态绑定放大率为空！");
		 $("#dynamicbindrate").focus();
			return false;
	 }
	 if(dynamicbindoffset==null||dynamicbindoffset.length<1){
		 alert("动态绑定偏移为空！");
		 $("#dynamicbindoffset").focus();
			return false;
	 }
	 if(staticbindoffset==null||staticbindoffset.length<1){
		 alert("静态绑定偏移为空！");
		 $("#dynamicbindoffset").focus();
			return false;
	 }
	 return true;
}
function do_finish(){
	if(!checkinput()){
		return;
	}
	var parametername=$("#parametername").val();
	var dynamicbindrate=	$("#dynamicbindrate").val();
	var dynamicbindoffset=$("#dynamicbindoffset").val();
	var staticbindrate=$("#staticbindrate").val();
	var staticbindoffset=$("#staticbindoffset").val();	 
	var dynamicbinddeviceid=$("#dynamicbindevice").val();
	var staticbinddeviceid=$("#staticbindevice").val();
	var dynamicbinddevicetargetcode=$("#dynamicbindevicetargetcode").val();
	var staticbinddevicetargetcode=$("#staticbinddevicetargetcode").val();
	if(parameterid==null){
		DataRoomService.callDataRoomService("EnergySetService","AddAddressParamSet",{addressid:addressid,
			parametername:parametername,dynamicbindrate:dynamicbindrate,dynamicbindoffset:dynamicbindoffset,
			staticbindrate:staticbindrate,staticbindoffset:staticbindoffset,
			dynamicbinddeviceid:dynamicbinddeviceid,staticbinddeviceid:staticbinddeviceid,
			dynamicbinddevicetargetcode:dynamicbinddevicetargetcode,staticbinddevicetargetcode:staticbinddevicetargetcode},showSaveResult,this,true);			 

	}else{
		DataRoomService.callDataRoomService("EnergySetService","EditAddressParamSet",{parameterid:parameterid,addressid:addressid,
			parametername:parametername,dynamicbindrate:dynamicbindrate,dynamicbindoffset:dynamicbindoffset,
			staticbindrate:staticbindrate,staticbindoffset:staticbindoffset,
			dynamicbinddeviceid:dynamicbinddeviceid,staticbinddeviceid:staticbinddeviceid,
			dynamicbinddevicetargetcode:dynamicbinddevicetargetcode,staticbinddevicetargetcode:staticbinddevicetargetcode
					},showSaveResult,this,true);			 

	}

	
}
function showSaveResult(data,callobj){
if(data.result){
	if(closecallback!=null){
		closecallback();
	}
}else{
	if(parameterid==null){
	alert("新增失败！");
	}
	else{
	alert("修改失败！");	
	}
}	
}

function showSaveResult(data,callobj){
	if(data.result=="ok"){
		if(closecallback!=null){
			closecallback();
		}
	}else{
		if(parameterid==null){
		alert("新增失败！"+data.result);
		}
		else{
		alert("修改失败！"+data.result);	
		}
	}	
	}
	 
	 function doclose(){
			if(closecallback!=null){
				closecallback();
			}
	 }
	 function init(){
		 DataRoomService.loginPage=/*[[#{system.loginpage}]]*/; 
		 DataRoomService.baseurl=/*[[@{/}]]*/;
		DataRoomComm.baseurl=/*[[@{/}]]*/;
	 }
/*]]>*/
</script>
</head>
<body   style="background-color:#ffffff;" onload="init();" >
<img id="progressImgage" class="ajaxprogress" style="display:none" alt="" th:src="@{/images/ajax-loader.gif}"/> 
<div id="maskOfProgressImage" class="ajaxmask" style="display:none"></div> 
 
 <div class="form-line" style="display:flex; ">
      <div style="width:85px;line-height:40px;" >名称</div >
    <input type="text"  id="parametername" placeholder="请输入参数名称" />
   
  </div>
  
   <div class="form-line" style="display:flex; ">
    <div style="width:85px;line-height:40px;" >动态数据绑定</div >
    <div style="display:flex;flex-direction:column;padding-left:5px">
      <select   id="dynamicbindevicetype" style="width:361px" >
       <option value="DH"  selected="selected">动环</option>
      </select>
      <div style="height:15px"></div>
      <select  onchange="getDeviceDigitaldictList('dynamic')" id="dynamicbindevice" style="width:361px" >
       <option value="" disabled="disabled" selected="selected">请选择设备</option>
      </select>
        <div style="height:15px"></div>
      <select    id="dynamicbindevicetargetcode" style="width:361px" >
       <option value="" disabled="disabled" selected="selected">请选择数据点位</option>
      </select>
    </div>
  </div>
  <div class="form-line" style="display:flex; ">
    <div style="width:85px;line-height:40px;">动态数据变换</div>
    <div  style="display:flex;align-items:center;padding-left:15px">
    <div>放大</div>
     <input type="number" style="width:117px" step="0.1"  min="1" max="1000000"  id="dynamicbindrate" value="1" />
    <div >倍</div>
      <div style="width:20px"></div>
    <div >偏移</div>
      <div style="width:10px"></div>
      <input type="number" style="width:117px" step="0.1"  min="-1000000" max="1000000"  id="dynamicbindoffset"  value="0"/>
    </div>
  </div>
    <div class="form-line" style="display:flex; ">
    <div style="width:85px;line-height:40px;" >静态数据绑定</div >
    <div style="display:flex;flex-direction:column;padding-left:5px">
      <select   id="staticbindevicetype" style="width:361px" >
       <option value="DH" selected="selected">动环</option>
      </select>
      <div style="height:15px"></div>
      <select  onchange="getDeviceDigitaldictList('static')"  id="staticbindevice" style="width:361px" >
       <option value="" disabled="disabled" selected="selected">请选择设备</option>
      </select>
        <div style="height:15px"></div>
      <select    id="staticbinddevicetargetcode" style="width:361px" >
       <option value="" disabled="disabled" selected="selected">请选择数据点位</option>
      </select>
    </div>
  </div>
  <div class="form-line" style="display:flex; ">
    <div style="width:85px;line-height:40px;">静态数据变换</div>
    <div  style="display:flex;align-items:center;padding-left:15px">
    <div>放大</div>
     <input type="number" style="width:117px" step="0.1"  min="1" max="1000000"  id="staticbindrate" value="1"/>
    <div >倍</div>
      <div style="width:20px"></div>
    <div >偏移</div>
      <div style="width:10px"></div>
      <input type="number" style="width:117px" step="0.1"  min="-1000000" max="1000000"  id="staticbindoffset" value="0"/>
    </div>
  </div>
     <div class="form-group" style="display:flex;align-items:center;justify-content:center">
     <button class="yl-btn blue" style="margin-right:20px" onclick="do_finish();">确定</button>
      <button class="yl-btn grey" style="margin-left:20px"  onclick="doclose();">取消</button>
     </div>
 
 	</body>
</html>